<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Refund Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind (your existing styles) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Bootstrap 5 (for modal/backdrop/focus trap) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    .card { @apply bg-white rounded-2xl shadow p-4; }
    .btn  { @apply inline-flex items-center justify-center rounded-xl px-3 py-2 border border-gray-300 hover:bg-gray-50 active:translate-y-[1px]; }
    .btn-primary { @apply bg-black text-white border-black hover:bg-gray-900; }
    .badge { @apply text-xs font-semibold px-2 py-1 rounded-full; }
    .badge-none { @apply bg-gray-200 text-gray-800; }
    .badge-partial { @apply bg-amber-200 text-amber-900; }
    .badge-full { @apply bg-emerald-200 text-emerald-900; }
    .badge-error { @apply bg-rose-200 text-rose-900; }
    .row-expand { @apply bg-gray-50; }
    .input, select, textarea { @apply w-full rounded-xl border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-black/50; }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="max-w-7xl mx-auto p-4 space-y-4">
    <header class="flex items-center justify-between">
      <h1 class="text-2xl md:text-3xl font-bold tracking-tight">Refund Manager</h1>
      <div class="flex items-center gap-2">
        <button id="refreshBtn" class="btn">Refresh</button>
      </div>
    </header>

    <section id="summary" class="grid grid-cols-1 md:grid-cols-4 gap-3">
      <div class="card">
        <div class="text-sm text-gray-500">Recommendations</div>
        <div class="text-2xl font-semibold" id="sum_recs">—</div>
        <div class="text-xs text-gray-500" id="sum_recs_breakdown">—</div>
      </div>
      <div class="card">
        <div class="text-sm text-gray-500">Suggested total (USD)</div>
        <div class="text-2xl font-semibold" id="sum_suggested">—</div>
      </div>
      <div class="card">
        <div class="text-sm text-gray-500">Decisions</div>
        <div class="text-2xl font-semibold" id="sum_decisions">—</div>
        <div class="text-xs text-gray-500" id="sum_decisions_breakdown">—</div>
      </div>
      <div class="card">
        <div class="text-sm text-gray-500">Pending</div>
        <div class="text-2xl font-semibold" id="sum_pending">—</div>
      </div>
    </section>

    <section class="card">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold">Orders & Suggestions</h2>
        <div class="text-sm text-gray-500">Showing latest</div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="text-left text-gray-500 border-b">
          <tr>
            <th class="py-2 pr-2">Order</th>
            <th class="py-2 pr-2">Suggested</th>
            <th class="py-2 pr-2">Reason</th>
            <th class="py-2 pr-2">Status</th>
            <th class="py-2 pr-2">Decision</th>
            <th class="py-2 pr-2"></th>
          </tr>
          </thead>
          <tbody id="ordersBody"></tbody>
        </table>
      </div>
      <div class="pt-3 flex items-center justify-between">
        <div class="text-xs text-gray-500">Data source: pg_recommendations</div>
        <div class="flex gap-2">
          <button class="btn" id="prevPage">Prev</button>
          <button class="btn" id="nextPage">Next</button>
        </div>
      </div>
    </section>
  </div>

  <!-- Bootstrap Modal (single instance, we fill + show it from JS) -->
  <div class="modal fade" id="refundModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <form id="refundForm" novalidate>
          <div class="modal-header">
            <h5 class="modal-title">Apply refund <span class="text-muted fs-6" id="rf_orderId_label"></span></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="rf_orderId" name="order_id" />
            <div class="mb-3">
              <label for="rf_amount" class="form-label">Amount (USD) *</label>
              <input id="rf_amount" name="amount_usd" type="number" min="0" step="0.01" required class="form-control">
            </div>
            <div class="mb-3">
              <label for="rf_class" class="form-label">Class *</label>
              <select id="rf_class" name="refund_class" required class="form-select">
                <option value="none">none</option>
                <option value="partial">partial</option>
                <option value="full">full</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="rf_reason" class="form-label">Reason *</label>
              <textarea id="rf_reason" name="reason" rows="3" required class="form-control"></textarea>
            </div>
            <div class="mb-1">
              <label for="rf_decided_by" class="form-label">Decided by (optional)</label>
              <input id="rf_decided_by" name="decided_by" class="form-control" placeholder="e.g. Nick">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" id="rf_submit" class="btn btn-primary">Apply refund</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS bundle (Popper + Modal) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ===== helpers =====
    const fmtUSD = (n) => (n==null||isNaN(n)) ? "—"
      : Number(n).toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:2});
    const badge = (cls) => {
      const map = {none:"badge badge-none", partial:"badge badge-partial", full:"badge badge-full", error:"badge badge-error"};
      return `<span class="${map[cls]||"badge"}">${cls||"unknown"}</span>`;
    };

    let page=0, limit=25; window.latestItems = [];

    // ===== API =====
    async function fetchSummary(){ return (await fetch("/api/summary")).json(); }
    async function fetchPage(){
      const r = await fetch(`/api/recommendations?limit=${limit}&offset=${page*limit}`);
      if(!r.ok) throw new Error(`GET /api/recommendations ${r.status}`);
      return r.json();
    }
    async function fetchEvents(orderId){
      const r = await fetch(`/api/orders/${orderId}/events`);
      if(!r.ok){ const j = await r.json().catch(()=>({})); throw new Error(j?.message||j?.detail||r.statusText); }
      return r.json();
    }

    // ===== renderers =====
    function renderSummary(d){
      document.getElementById("sum_recs").textContent = d.recommendations_count ?? "—";
      document.getElementById("sum_suggested").textContent = fmtUSD(d.suggested_total_usd);
      document.getElementById("sum_decisions").textContent = d.decisions_count ?? "—";
      document.getElementById("sum_pending").textContent = d.pending_count ?? "—";
      const s1 = Object.entries(d.suggestions_by_class||{}).map(([k,v])=>`${k}: ${v}`).join(" · ");
      const s2 = Object.entries(d.decisions_by_class||{}).map(([k,v])=>`${k}: ${v}`).join(" · ");
      document.getElementById("sum_recs_breakdown").textContent = s1||"—";
      document.getElementById("sum_decisions_breakdown").textContent = s2||"—";
    }

    function rowId(id){ return `row-${id}` } ; function expId(id){ return `exp-${id}` }

    function renderRows(items){
      window.latestItems = items;
      const tb = document.getElementById("ordersBody"); tb.innerHTML="";
      for(const it of items){
        const sug = it.suggestion||{}; const dec = it.decision||null;
        const tr = document.createElement("tr");
        tr.id = rowId(it.order_id); tr.className="border-b";
        tr.innerHTML = `
          <td class="py-2 pr-2 font-mono text-xs md:text-sm">${it.order_id}</td>
          <td class="py-2 pr-2">${fmtUSD(sug.refund_usd)} ${badge(sug.refund_class)}</td>
          <td class="py-2 pr-2 text-gray-600">${sug.reason||"—"}</td>
          <td class="py-2 pr-2">${it.status==="applied" ? '<span class="badge bg-emerald-200 text-emerald-900">applied</span>' : '<span class="badge bg-gray-200 text-gray-800">pending</span>'}</td>
          <td class="py-2 pr-2">${dec ? `${fmtUSD(dec.amount_usd)} ${badge(dec.refund_class)} <span class="text-xs text-gray-500">(${new Date(dec.decided_ts).toLocaleString()})</span>`:"—"}</td>
          <td class="py-2 pr-2 text-right">
            <div class="flex gap-2 justify-end">
              <button class="btn" data-expand="${it.order_id}">Details</button>
              <button class="btn btn-primary" data-apply="${it.order_id}">Apply</button>
            </div>
          </td>`;
        tb.appendChild(tr);

        const exp = document.createElement("tr");
        exp.id = expId(it.order_id); exp.className = "hidden row-expand";
        exp.innerHTML = `<td colspan="6" class="p-3"><div class="text-sm text-gray-500">Loading events…</div></td>`;
        tb.appendChild(exp);
      }
    }

    function renderEvents(events){
      if(!events.length) return `<div class="text-sm text-gray-500">No events found.</div>`;
      const lines = events.map(ev=>{
        const body = typeof ev.body==="object" ? JSON.stringify(ev.body) : (ev.body||"");
        return `
          <div class="grid grid-cols-1 md:grid-cols-8 gap-2 py-2 border-b">
            <div class="md:col-span-2 font-mono text-xs">${ev.ts??""}</div>
            <div class="md:col-span-2"><span class="badge bg-gray-200">${ev.event_type}</span></div>
            <div class="md:col-span-4 text-xs text-gray-700 break-words">${body}</div>
          </div>`;
      }).join("");
      return `<div class="text-sm font-semibold mb-2">Order timeline</div>
              <div class="rounded-xl border overflow-hidden">${lines}</div>`;
    }

    // ===== modal logic (Bootstrap) =====
    const refundModalEl = document.getElementById('refundModal');
    const refundModal = new bootstrap.Modal(refundModalEl);

    function openApplyModal(item){
      const sug = item?.suggestion || {};
      document.getElementById("rf_orderId").value = item.order_id;
      document.getElementById("rf_orderId_label").textContent = `(${item.order_id})`;
      document.getElementById("rf_amount").value = Number(sug.refund_usd)||0;
      document.getElementById("rf_class").value = (sug.refund_class==="partial"||sug.refund_class==="full") ? sug.refund_class : "none";
      document.getElementById("rf_reason").value = sug.reason || "";
      document.getElementById("rf_decided_by").value = "";
      refundModal.show();
    }

    // submit handler (POST /api/refunds)
    document.getElementById("refundForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const form = e.target;
      if (!form.checkValidity()) { form.reportValidity(); return; }

      const payload = {
        order_id: document.getElementById("rf_orderId").value,
        amount_usd: Number(document.getElementById("rf_amount").value),
        refund_class: document.getElementById("rf_class").value,
        reason: document.getElementById("rf_reason").value,
        decided_by: document.getElementById("rf_decided_by").value || null
      };

      const btn = document.getElementById("rf_submit");
      const original = btn.textContent;
      btn.disabled = true; btn.textContent = "Applying…";
      try {
        const r = await fetch("/api/refunds", {
          method:"POST",
          headers:{"Content-Type":"application/json", "Accept":"application/json"},
          body: JSON.stringify(payload)
        });
        const data = await r.json().catch(()=> ({}));
        if (!r.ok) {
          const msg = data?.detail?.error || data?.detail || data?.message || r.statusText;
          alert(`Failed to apply refund:\n${msg}`);
          return;
        }
        refundModal.hide();
        await refreshAll();
      } catch (err) {
        console.error("POST /api/refunds failed", err);
        alert(`Network error applying refund:\n${err?.message||err}`);
      } finally {
        btn.disabled = false; btn.textContent = original;
      }
    });

    // ===== event delegation =====
    document.addEventListener("click", async (e) => {
      const applyBtn  = e.target.closest("button[data-apply]");
      const expandBtn = e.target.closest("button[data-expand]");

      if (applyBtn) {
        const id = applyBtn.getAttribute("data-apply");
        let item = (window.latestItems||[]).find(x => String(x.order_id) === String(id));
        if (!item) item = { order_id: id, suggestion: { refund_usd: 0, refund_class: "none", reason: "" } };
        openApplyModal(item);
        return;
      }

      if (expandBtn) {
        const id = expandBtn.getAttribute("data-expand");
        const row = document.getElementById(`exp-${id}`);
        if (!row) return;
        if (!row.classList.contains("hidden")) { row.classList.add("hidden"); return; }
        row.classList.remove("hidden");
        const cell = row.querySelector("td");
        cell.innerHTML = `<div class="text-sm text-gray-500">Loading events…</div>`;
        try {
          const data = await fetchEvents(id);
          cell.innerHTML = renderEvents(data.events||[]);
        } catch (err) {
          console.error(err);
          cell.innerHTML = `<div class="text-red-600 text-sm">Failed: ${err?.message||err}</div>`;
        }
      }
    });

    // ===== boot =====
    async function refreshAll(){
      const [s,p] = await Promise.all([fetchSummary(), fetchPage()]);
      renderSummary(s); renderRows(p.items||[]);
    }
    document.getElementById("refreshBtn").onclick = refreshAll;
    document.getElementById("nextPage").onclick = ()=>{ page++; refreshAll(); };
    document.getElementById("prevPage").onclick = ()=>{ page=Math.max(0,page-1); refreshAll(); };
    refreshAll();
  </script>
</body>
</html>
